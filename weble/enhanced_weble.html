<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢å¼ºç‰ˆç”µå­å¢¨æ°´å±æ—¶é’Ÿæ§åˆ¶</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .primary { background-color: #007bff; color: white; }
        .primary:hover { background-color: #0056b3; }
        .secondary { background-color: #6c757d; color: white; }
        .secondary:hover { background-color: #545b62; }
        .success { background-color: #28a745; color: white; }
        .success:hover { background-color: #1e7e34; }
        .warning { background-color: #ffc107; color: black; }
        .warning:hover { background-color: #e0a800; }
        .danger { background-color: #dc3545; color: white; }
        .danger:hover { background-color: #c82333; }
        button:disabled {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }
        .info-panel {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .status.success { background-color: #d4edda; color: #155724; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .status.info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>å¢å¼ºç‰ˆç”µå­å¢¨æ°´å±æ—¶é’Ÿæ§åˆ¶</h1>
    
    <div class="container">
        <h2>è¿æ¥è®¾å¤‡</h2>
        <div class="button-group">
            <button id="connect-button" class="primary">è¿æ¥è®¾å¤‡</button>
            <button id="restart-button" class="danger" disabled>é‡å¯è®¾å¤‡</button>
        </div>
        <div class="button-group">
            <a href="debug_bluetooth.html" target="_blank" style="text-decoration: none;">
                <button class="secondary">ğŸ” è“ç‰™è°ƒè¯•å·¥å…·</button>
            </a>
            <button id="check-bluetooth" class="secondary">æ£€æŸ¥è“ç‰™æ”¯æŒ</button>
        </div>
        <div class="info-panel">
            <div id="device_name">è®¾å¤‡å: æœªè¿æ¥</div>
            <div id="current_voltage">å½“å‰ç”µå‹: --</div>
            <div id="current_time">è®¾å¤‡æ—¶é—´: --</div>
            <div id="system_time">ç³»ç»Ÿæ—¶é—´: --</div>
        </div>
    </div>

    <div class="container">
        <h2>æ—¶é—´åŒæ­¥</h2>
        <div class="button-group">
            <button id="setime-button" class="success" disabled>åŒæ­¥æ—¶é—´</button>
        </div>
        <div class="input-group">
            <label for="timezone">æ—¶åŒºè®¾ç½®:</label>
            <select id="timezone">
                <option value="-12">UTC-12</option>
                <option value="-11">UTC-11</option>
                <option value="-10">UTC-10</option>
                <option value="-9">UTC-9</option>
                <option value="-8">UTC-8</option>
                <option value="-7">UTC-7</option>
                <option value="-6">UTC-6</option>
                <option value="-5">UTC-5</option>
                <option value="-4">UTC-4</option>
                <option value="-3">UTC-3</option>
                <option value="-2">UTC-2</option>
                <option value="-1">UTC-1</option>
                <option value="0">UTC+0</option>
                <option value="1">UTC+1</option>
                <option value="2">UTC+2</option>
                <option value="3">UTC+3</option>
                <option value="4">UTC+4</option>
                <option value="5">UTC+5</option>
                <option value="6">UTC+6</option>
                <option value="7">UTC+7</option>
                <option value="8" selected>UTC+8 (åŒ—äº¬æ—¶é—´)</option>
                <option value="9">UTC+9</option>
                <option value="10">UTC+10</option>
                <option value="11">UTC+11</option>
                <option value="12">UTC+12</option>
            </select>
        </div>
        <div class="button-group">
            <button id="set-timezone-button" class="secondary" disabled>è®¾ç½®æ—¶åŒº</button>
            <button id="timezone-plus-button" class="secondary" disabled>æ—¶åŒº+1</button>
        </div>
    </div>

    <div class="container">
        <h2>æ˜¾ç¤ºæ¨¡å¼</h2>
        <div class="button-group">
            <button id="mode-clock" class="primary" disabled>æ—¶é’Ÿæ¨¡å¼</button>
            <button id="mode-calendar" class="primary" disabled>æ—¥å†æ¨¡å¼</button>
            <button id="mode-image" class="primary" disabled>å›¾ç‰‡æ¨¡å¼</button>
        </div>
        <div class="info-panel">
            <p>ğŸ’¡ æç¤ºï¼šè¦ä¸Šä¼ è‡ªå®šä¹‰å›¾ç‰‡ï¼Œè¯·ä½¿ç”¨ <a href="image_upload.html" target="_blank" style="color: #007bff;">å›¾ç‰‡ä¸Šä¼ å·¥å…·</a></p>
        </div>
    </div>

    <div class="container">
        <h2>å±å¹•æ§åˆ¶</h2>
        <div class="button-group">
            <button id="refresh-screen" class="secondary" disabled>å¼ºåˆ¶åˆ·æ–°</button>
            <button id="invert-screen" class="warning" disabled>åè‰²æ˜¾ç¤º</button>
            <button id="clear-screen" class="secondary" disabled>æ¸…ç©ºå±å¹•</button>
        </div>
    </div>

    <div class="container">
        <h2>è‡ªå®šä¹‰æ–‡æœ¬</h2>
        <div class="input-group">
            <label for="custom-text">è‡ªå®šä¹‰æ–‡æœ¬å†…å®¹ (æ”¯æŒå˜é‡: {Y}å¹´ {M}æœˆ {D}æ—¥ {W}æ˜ŸæœŸ):</label>
            <textarea id="custom-text" placeholder="ä¾‹å¦‚: ä»Šå¤©æ˜¯{Y}{M}{D} {W}&#10;ç°åœ¨æ—¶é—´: {y}-{m}-{d}"></textarea>
        </div>
        <div class="button-group">
            <button id="send-custom-text" class="success" disabled>å‘é€è‡ªå®šä¹‰æ–‡æœ¬</button>
            <button id="reset-display" class="secondary" disabled>é‡ç½®æ˜¾ç¤º</button>
        </div>
    </div>

    <div class="container">
        <h2>å‚æ•°ç®¡ç†</h2>
        <div class="button-group">
            <button id="save-params" class="success" disabled>ä¿å­˜å‚æ•°</button>
        </div>
    </div>

    <div id="status-message"></div>

    <script src="log.js"></script>
    <script>
        let connected = false;
        let device = null;
        let longValue = null;

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 3000);
        }

        function formatTime(year, month, mday, hour, min, sec) {
            month += 1;
            if(month<10) month = '0'+month;
            if(mday<10)  mday  = '0'+mday;
            if(hour<10)  hour  = '0'+hour;
            if(min<10)   min   = '0'+min;
            if(sec<10)   sec   = '0'+sec;
            return year+"-"+month+"-"+mday+" "+hour+":"+min+":"+sec+" ";
        }

        function updateButtonStates(isConnected) {
            const buttons = [
                'restart-button', 'setime-button', 'set-timezone-button', 
                'timezone-plus-button', 'mode-clock', 'mode-calendar', 
                'mode-image', 'refresh-screen', 'invert-screen', 
                'clear-screen', 'send-custom-text', 'reset-display', 'save-params'
            ];
            
            buttons.forEach(id => {
                document.getElementById(id).disabled = !isConnected;
            });
        }

        async function connectToDevice() {
            try {
                console.log('è¯·æ±‚è®¾å¤‡...');
                device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: "DLG-CLOCK" },
                        { namePrefix: "CLOCK" },
                        { namePrefix: "DLG" },
                        { namePrefix: "HM" },
                        { namePrefix: "EPD" },
                        { services: [0xff00] }
                    ],
                    optionalServices: [ 0xff00 ]
                });
                
                console.log('device: ', device.name);
                document.getElementById('device_name').textContent = "è®¾å¤‡å: "+device.name;
                device.ongattserverdisconnected = onDisconnect;

                const server = await device.gatt.connect();
                console.log('è®¾å¤‡å·²è¿æ¥!');

                const service = await server.getPrimaryService( 0xff00 );
                console.log('è·å¾—service: ', service.uuid);

                const ctrlPoint = await service.getCharacteristic( 0xff03 );
                const adc1Value = await service.getCharacteristic( 0xff02 );
                longValue = await service.getCharacteristic( 0xff01 );

                const cur_voltage = await adc1Value.readValue();
                console.log('cur_voltage:', cur_voltage);
                document.getElementById('current_voltage').textContent = "å½“å‰ç”µå‹: "+cur_voltage.getUint16(0, true) + "mV";

                const cur_time = await longValue.readValue();
                const year = cur_time.getUint16(0, true);
                const month = cur_time.getUint8(2);
                const mday = cur_time.getUint8(3);
                const hour = cur_time.getUint8(4);
                const minute = cur_time.getUint8(5);
                const second = cur_time.getUint8(6);
                document.getElementById('current_time').textContent = "è®¾å¤‡æ—¶é—´: "+formatTime(year, month, mday, hour, minute, second);

                const today = new Date();
                document.getElementById('system_time').textContent = "ç³»ç»Ÿæ—¶é—´: "+formatTime(
                    today.getFullYear(), today.getMonth(), today.getDate(), 
                    today.getHours(), today.getMinutes(), today.getSeconds()
                );

                connected = true;
                updateButtonStates(true);
                document.getElementById('connect-button').textContent = "æ–­å¼€è¿æ¥";
                showStatus('è®¾å¤‡è¿æ¥æˆåŠŸ!', 'success');
            } catch (error) {
                console.log('è¿æ¥å¤±è´¥:', error);
                showStatus('è¿æ¥å¤±è´¥: ' + error.message, 'error');
                disconnect();
            }
        }

        function disconnect() {
            if(device && device.gatt.connected){
                device.gatt.disconnect();
            }
            onDisconnect();
        }

        function onDisconnect() {
            device = null;
            console.log('è®¾å¤‡å·²æ–­å¼€è¿æ¥');
            connected = false;
            updateButtonStates(false);
            document.getElementById('connect-button').textContent = "è¿æ¥è®¾å¤‡";
            document.getElementById('device_name').textContent = "è®¾å¤‡å: æœªè¿æ¥";
            showStatus('è®¾å¤‡å·²æ–­å¼€è¿æ¥', 'info');
        }

        async function sendCommand(commandArray) {
            if (!connected || !longValue) {
                showStatus('è®¾å¤‡æœªè¿æ¥', 'error');
                return;
            }
            
            try {
                const buffer = new Uint8Array(commandArray);
                await longValue.writeValue(buffer);
                console.log('å‘½ä»¤å‘é€æˆåŠŸ:', commandArray);
                return true;
            } catch (error) {
                console.error('å‘½ä»¤å‘é€å¤±è´¥:', error);
                showStatus('å‘½ä»¤å‘é€å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('connect-button').addEventListener('click', () => {
            if(connected) {
                disconnect();
            } else {
                connectToDevice();
            }
        });

        document.getElementById('restart-button').addEventListener('click', async () => {
            if (await sendCommand([0xAA])) {
                showStatus('é‡å¯å‘½ä»¤å·²å‘é€', 'success');
            }
        });

        document.getElementById('setime-button').addEventListener('click', async () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const mday = today.getDate();
            const wday = today.getDay();
            const hour = today.getHours();
            const minute = today.getMinutes();
            const second = today.getSeconds();

            // è·å–å†œå†ä¿¡æ¯
            const locale_str = today.toLocaleDateString('zh-CN-u-ca-chinese',{month:'numeric',day:'numeric'});
            let l_month = 0;
            if(locale_str.charAt(0)=='é—°'){
                l_month = 128;
                locale_str = locale_str.substr(1,);
            }
            const lstr_split = locale_str.split('-');
            l_month += parseInt(lstr_split[0]);
            const l_mday = parseInt(lstr_split[1]);
            const locale_year = today.toLocaleDateString('zh-CN-u-ca-chinese',{year:'numeric'});
            const l_year = parseInt(locale_year.substr(0,4));

            const buf = [
                0x91,
                year % 256,
                Math.floor(year / 256),
                month,
                mday,
                hour,
                minute,
                second,
                wday,
                l_year - 2020,
                l_month - 1,
                l_mday
            ];

            if (await sendCommand(buf)) {
                showStatus('æ—¶é—´åŒæ­¥æˆåŠŸ!', 'success');
                document.getElementById('system_time').textContent = "ç³»ç»Ÿæ—¶é—´: "+formatTime(year, month, mday, hour, minute, second);
            }
        });

        document.getElementById('set-timezone-button').addEventListener('click', async () => {
            const timezone = parseInt(document.getElementById('timezone').value);
            if (await sendCommand([0xEF, timezone, 0, 0, 0])) {
                showStatus(`æ—¶åŒºè®¾ç½®ä¸º UTC${timezone >= 0 ? '+' : ''}${timezone}`, 'success');
            }
        });

        document.getElementById('timezone-plus-button').addEventListener('click', async () => {
            if (await sendCommand([0xE4])) {
                showStatus('æ—¶åŒº+1', 'success');
            }
        });

        document.getElementById('mode-clock').addEventListener('click', async () => {
            if (await sendCommand([0xE1, 0x02])) {
                showStatus('åˆ‡æ¢åˆ°æ—¶é’Ÿæ¨¡å¼', 'success');
            }
        });

        document.getElementById('mode-calendar').addEventListener('click', async () => {
            if (await sendCommand([0xE1, 0x01])) {
                showStatus('åˆ‡æ¢åˆ°æ—¥å†æ¨¡å¼', 'success');
            }
        });

        document.getElementById('mode-image').addEventListener('click', async () => {
            if (await sendCommand([0xE1, 0x00])) {
                showStatus('åˆ‡æ¢åˆ°å›¾ç‰‡æ¨¡å¼', 'success');
            }
        });

        document.getElementById('refresh-screen').addEventListener('click', async () => {
            if (await sendCommand([0xE2])) {
                showStatus('å±å¹•å¼ºåˆ¶åˆ·æ–°', 'success');
            }
        });

        document.getElementById('invert-screen').addEventListener('click', async () => {
            if (await sendCommand([0xE3])) {
                showStatus('åè‰²æ˜¾ç¤ºåˆ‡æ¢', 'success');
            }
        });

        document.getElementById('clear-screen').addEventListener('click', async () => {
            if (await sendCommand([0xE0, 0x01])) {
                showStatus('å±å¹•å·²æ¸…ç©º', 'success');
            }
        });

        document.getElementById('send-custom-text').addEventListener('click', async () => {
            const text = document.getElementById('custom-text').value;
            if (!text.trim()) {
                showStatus('è¯·è¾“å…¥è‡ªå®šä¹‰æ–‡æœ¬', 'error');
                return;
            }

            const textBytes = new TextEncoder().encode(text);
            const command = [0xF2, 0x00, ...textBytes];
            
            if (await sendCommand(command)) {
                showStatus('è‡ªå®šä¹‰æ–‡æœ¬å·²å‘é€', 'success');
            }
        });

        document.getElementById('reset-display').addEventListener('click', async () => {
            if (await sendCommand([0x24])) { // '$' çš„ASCIIç 
                showStatus('æ˜¾ç¤ºå·²é‡ç½®', 'success');
            }
        });

        document.getElementById('save-params').addEventListener('click', async () => {
            if (await sendCommand([0x23, 0x23, 0x23])) { // '###' çš„ASCIIç 
                showStatus('å‚æ•°å·²ä¿å­˜', 'success');
            }
        });

        // è“ç‰™æ”¯æŒæ£€æŸ¥
        document.getElementById('check-bluetooth').addEventListener('click', () => {
            let info = 'ğŸ” è“ç‰™æ”¯æŒæ£€æŸ¥ç»“æœ:\n\n';
            
            // æ£€æŸ¥Web Bluetooth APIæ”¯æŒ
            if ('bluetooth' in navigator) {
                info += 'âœ… æµè§ˆå™¨æ”¯æŒWeb Bluetooth API\n';
            } else {
                info += 'âŒ æµè§ˆå™¨ä¸æ”¯æŒWeb Bluetooth API\n';
                info += '   æ¨èä½¿ç”¨Chromeã€Edgeæˆ–Operaæµè§ˆå™¨\n';
            }
            
            // æ£€æŸ¥HTTPS
            if (location.protocol === 'https:' || location.hostname === 'localhost') {
                info += 'âœ… ç½‘ç«™ä½¿ç”¨å®‰å…¨è¿æ¥ (HTTPS)\n';
            } else {
                info += 'âŒ ç½‘ç«™æœªä½¿ç”¨HTTPSï¼ŒWeb Bluetoothéœ€è¦å®‰å…¨è¿æ¥\n';
            }
            
            // æ£€æŸ¥ç”¨æˆ·ä»£ç†
            const userAgent = navigator.userAgent;
            if (userAgent.includes('Chrome')) {
                info += 'âœ… æ£€æµ‹åˆ°Chromeæµè§ˆå™¨\n';
            } else if (userAgent.includes('Edg')) {
                info += 'âœ… æ£€æµ‹åˆ°Edgeæµè§ˆå™¨\n';
            } else if (userAgent.includes('Opera')) {
                info += 'âœ… æ£€æµ‹åˆ°Operaæµè§ˆå™¨\n';
            } else {
                info += 'âš ï¸ æœªæ£€æµ‹åˆ°æ¨èçš„æµè§ˆå™¨\n';
            }
            
            info += '\nğŸ’¡ å¦‚æœä»ç„¶æ— æ³•è¿æ¥è®¾å¤‡ï¼š\n';
            info += '1. ä½¿ç”¨è“ç‰™è°ƒè¯•å·¥å…·æ‰«æè®¾å¤‡\n';
            info += '2. ç¡®ä¿è®¾å¤‡å¤„äºå¹¿æ’­çŠ¶æ€\n';
            info += '3. æ£€æŸ¥è®¾å¤‡è·ç¦»ï¼ˆå»ºè®®1-2ç±³å†…ï¼‰\n';
            info += '4. é‡å¯æµè§ˆå™¨å’Œç³»ç»Ÿè“ç‰™\n';
            
            alert(info);
        });

        // åˆå§‹åŒ–
        updateButtonStates(false);
        
        // æ£€æŸ¥è“ç‰™æ”¯æŒå¹¶æ˜¾ç¤ºæç¤º
        if (!('bluetooth' in navigator)) {
            showStatus('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒWeb Bluetoothï¼Œè¯·ä½¿ç”¨Chromeã€Edgeæˆ–Opera', 'error');
        }
        
        // å®šæ—¶æ›´æ–°ç³»ç»Ÿæ—¶é—´
        setInterval(() => {
            if (!connected) return;
            const today = new Date();
            document.getElementById('system_time').textContent = "ç³»ç»Ÿæ—¶é—´: "+formatTime(
                today.getFullYear(), today.getMonth(), today.getDate(), 
                today.getHours(), today.getMinutes(), today.getSeconds()
            );
        }, 1000);
    </script>
</body>
</html>