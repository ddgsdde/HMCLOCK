<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>æ™ºèƒ½æ—¶é’Ÿé…ç½®</title>
	<style>
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			margin: 0;
			padding: 20px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			color: #333;
		}
		.container {
			max-width: 800px;
			margin: 0 auto;
			background: white;
			border-radius: 15px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.2);
			overflow: hidden;
		}
		.header {
			background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
			color: white;
			padding: 20px;
			text-align: center;
		}
		.header h1 {
			margin: 0;
			font-size: 2em;
		}
		.content {
			padding: 20px;
		}
		.section {
			margin-bottom: 30px;
			padding: 20px;
			border: 1px solid #e0e0e0;
			border-radius: 10px;
			background: #f9f9f9;
		}
		.section h2 {
			margin-top: 0;
			color: #4facfe;
			border-bottom: 2px solid #4facfe;
			padding-bottom: 10px;
		}
		.button-group {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
			margin-bottom: 20px;
		}
		button {
			padding: 12px 24px;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-size: 14px;
			font-weight: 600;
			transition: all 0.3s ease;
			min-width: 100px;
		}
		.btn-primary {
			background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
			color: white;
		}
		.btn-primary:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
		}
		.btn-secondary {
			background: #6c757d;
			color: white;
		}
		.btn-secondary:hover {
			background: #5a6268;
		}
		.btn-success {
			background: #28a745;
			color: white;
		}
		.btn-success:hover {
			background: #218838;
		}
		.btn-danger {
			background: #dc3545;
			color: white;
		}
		.btn-danger:hover {
			background: #c82333;
		}
		button:disabled {
			background: #ccc;
			cursor: not-allowed;
			transform: none;
		}
		.form-group {
			margin-bottom: 15px;
		}
		label {
			display: block;
			margin-bottom: 5px;
			font-weight: 600;
			color: #555;
		}
		input, select, textarea {
			width: 100%;
			padding: 10px;
			border: 1px solid #ddd;
			border-radius: 5px;
			font-size: 14px;
			box-sizing: border-box;
		}
		input:focus, select:focus, textarea:focus {
			outline: none;
			border-color: #4facfe;
			box-shadow: 0 0 5px rgba(79, 172, 254, 0.3);
		}
		.status-info {
			background: #e3f2fd;
			border: 1px solid #2196f3;
			border-radius: 5px;
			padding: 10px;
			margin-bottom: 10px;
		}
		.countdown-list {
			max-height: 300px;
			overflow-y: auto;
			border: 1px solid #ddd;
			border-radius: 5px;
			padding: 10px;
		}
		.countdown-item {
			background: white;
			border: 1px solid #e0e0e0;
			border-radius: 5px;
			padding: 10px;
			margin-bottom: 10px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		.countdown-item:last-child {
			margin-bottom: 0;
		}
		.countdown-info {
			flex: 1;
		}
		.countdown-name {
			font-weight: 600;
			color: #333;
		}
		.countdown-date {
			color: #666;
			font-size: 12px;
		}
		.countdown-actions {
			display: flex;
			gap: 5px;
		}
		.countdown-actions button {
			padding: 5px 10px;
			font-size: 12px;
			min-width: auto;
		}
		.image-upload {
			border: 2px dashed #ddd;
			border-radius: 10px;
			padding: 20px;
			text-align: center;
			cursor: pointer;
			transition: all 0.3s ease;
		}
		.image-upload:hover {
			border-color: #4facfe;
			background: #f0f8ff;
		}
		.image-upload.dragover {
			border-color: #4facfe;
			background: #e3f2fd;
		}
		.image-preview {
			max-width: 200px;
			max-height: 200px;
			margin: 10px auto;
			display: block;
			border-radius: 5px;
		}
		.tabs {
			display: flex;
			border-bottom: 1px solid #ddd;
			margin-bottom: 20px;
		}
		.tab {
			padding: 10px 20px;
			cursor: pointer;
			border-bottom: 2px solid transparent;
			transition: all 0.3s ease;
		}
		.tab.active {
			border-bottom-color: #4facfe;
			color: #4facfe;
			font-weight: 600;
		}
		.tab-content {
			display: none;
		}
		.tab-content.active {
			display: block;
		}
		.grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
		}
		.card {
			background: white;
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			padding: 15px;
			text-align: center;
			cursor: pointer;
			transition: all 0.3s ease;
		}
		.card:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(0,0,0,0.1);
		}
		.card.selected {
			border-color: #4facfe;
			background: #f0f8ff;
		}
		.card h3 {
			margin: 0 0 10px 0;
			color: #333;
		}
		.card p {
			margin: 0;
			color: #666;
			font-size: 12px;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="header">
			<h1>ğŸ• æ™ºèƒ½æ—¶é’Ÿé…ç½®</h1>
			<p>é€šè¿‡è“ç‰™é…ç½®æ‚¨çš„æ™ºèƒ½æ—¶é’Ÿæ˜¾ç¤ºæ¨¡å¼å’ŒåŠŸèƒ½</p>
		</div>
		
		<div class="content">
			<!-- è¿æ¥çŠ¶æ€ -->
			<div class="section">
				<h2>è®¾å¤‡è¿æ¥</h2>
				<div class="button-group">
					<button id="connect-button" class="btn-primary">è¿æ¥è®¾å¤‡</button>
					<button id="setime-button" class="btn-success" disabled>åŒæ­¥æ—¶é—´</button>
					<button id="upfirm-button" class="btn-secondary" disabled>å›ºä»¶å‡çº§</button>
				</div>
				<div id="device_name" class="status-info"></div>
				<div id="current_voltage" class="status-info"></div>
				<div id="current_time" class="status-info"></div>
				<div id="system_time" class="status-info"></div>
			</div>

			<!-- æ˜¾ç¤ºæ¨¡å¼é…ç½® -->
			<div class="section">
				<h2>æ˜¾ç¤ºæ¨¡å¼</h2>
				<div class="tabs">
					<div class="tab active" data-tab="time-mode">æ—¶é—´æ¨¡å¼</div>
					<div class="tab" data-tab="calendar-mode">æ—¥å†æ¨¡å¼</div>
					<div class="tab" data-tab="image-mode">å›¾ç‰‡æ¨¡å¼</div>
					<div class="tab" data-tab="countdown-mode">å€’æ•°æ—¥</div>
				</div>
				
				<div id="time-mode" class="tab-content active">
					<h3>æ—¶é—´æ˜¾ç¤ºæ ·å¼</h3>
					<div class="grid">
						<div class="card" data-style="digital">
							<h3>æ•°å­—æ—¶é’Ÿ</h3>
							<p>ç»å…¸æ•°å­—æ˜¾ç¤ºï¼Œæ¸…æ™°æ˜“è¯»</p>
						</div>
						<div class="card" data-style="analog">
							<h3>æ¨¡æ‹Ÿæ—¶é’Ÿ</h3>
							<p>ä¼ ç»ŸæŒ‡é’ˆæ—¶é’Ÿæ ·å¼</p>
						</div>
						<div class="card" data-style="minimal">
							<h3>æç®€é£æ ¼</h3>
							<p>ç®€çº¦è®¾è®¡ï¼Œçªå‡ºæ—¶é—´</p>
						</div>
						<div class="card" data-style="retro">
							<h3>å¤å¤é£æ ¼</h3>
							<p>æ€€æ—§è®¾è®¡ï¼Œç»å…¸è£…é¥°</p>
						</div>
						<div class="card" data-style="neon">
							<h3>éœ“è™¹é£æ ¼</h3>
							<p>å‘å…‰æ•ˆæœï¼Œç°ä»£æ„Ÿå¼º</p>
						</div>
					</div>
					
					<div class="form-group">
						<label>
							<input type="checkbox" id="show-seconds"> æ˜¾ç¤ºç§’æ•°
						</label>
					</div>
					<div class="form-group">
						<label>
							<input type="checkbox" id="show-date"> æ˜¾ç¤ºæ—¥æœŸ
						</label>
					</div>
					<div class="form-group">
						<label>
							<input type="checkbox" id="show-lunar"> æ˜¾ç¤ºå†œå†
						</label>
					</div>
					<div class="form-group">
						<label>
							<input type="checkbox" id="show-festival"> æ˜¾ç¤ºèŠ‚æ—¥
						</label>
					</div>
				</div>
				
				<div id="calendar-mode" class="tab-content">
					<h3>æ—¥å†æ˜¾ç¤ºæ ·å¼</h3>
					<div class="grid">
						<div class="card" data-style="grid">
							<h3>ç½‘æ ¼æ—¥å†</h3>
							<p>ä¼ ç»Ÿæœˆå†ç½‘æ ¼å¸ƒå±€</p>
						</div>
						<div class="card" data-style="list">
							<h3>åˆ—è¡¨æ—¥å†</h3>
							<p>å‚ç›´åˆ—è¡¨æ˜¾ç¤º</p>
						</div>
						<div class="card" data-style="minimal">
							<h3>æç®€æ—¥å†</h3>
							<p>ç®€çº¦æ—¥å†è®¾è®¡</p>
						</div>
						<div class="card" data-style="chinese">
							<h3>ä¸­å¼æ—¥å†</h3>
							<p>å†œå†ä¸ºä¸»çš„ä¼ ç»Ÿæ ·å¼</p>
						</div>
						<div class="card" data-style="modern">
							<h3>ç°ä»£é£æ ¼</h3>
							<p>ç°ä»£åŒ–è®¾è®¡è¯­è¨€</p>
						</div>
					</div>
				</div>
				
				<div id="image-mode" class="tab-content">
					<h3>å›¾ç‰‡ç®¡ç†</h3>
					<div class="image-upload" id="image-upload">
						<p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</p>
						<p style="font-size: 12px; color: #666;">æ”¯æŒ JPG, PNG æ ¼å¼ï¼Œæœ€å¤§ 32KB</p>
						<input type="file" id="image-file" accept="image/*" style="display: none;">
					</div>
					<div id="image-preview"></div>
					<button id="upload-image" class="btn-primary" disabled>ä¸Šä¼ å›¾ç‰‡</button>
				</div>
				
				<div id="countdown-mode" class="tab-content">
					<h3>å€’æ•°æ—¥ç®¡ç†</h3>
					<div class="button-group">
						<button id="add-countdown" class="btn-primary">æ·»åŠ å€’æ•°æ—¥</button>
					</div>
					<div id="countdown-list" class="countdown-list">
						<!-- å€’æ•°æ—¥åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
					</div>
				</div>
			</div>

			<!-- å€’æ•°æ—¥ç¼–è¾‘è¡¨å• -->
			<div id="countdown-form" class="section" style="display: none;">
				<h2>ç¼–è¾‘å€’æ•°æ—¥</h2>
				<div class="form-group">
					<label for="countdown-name">äº‹ä»¶åç§°</label>
					<input type="text" id="countdown-name" placeholder="ä¾‹å¦‚ï¼šç”Ÿæ—¥ã€çºªå¿µæ—¥">
				</div>
				<div class="form-group">
					<label for="countdown-desc">äº‹ä»¶æè¿°</label>
					<textarea id="countdown-desc" rows="3" placeholder="äº‹ä»¶çš„è¯¦ç»†æè¿°"></textarea>
				</div>
				<div class="form-group">
					<label for="countdown-type">é‡å¤ç±»å‹</label>
					<select id="countdown-type">
						<option value="0">ä¸€æ¬¡æ€§äº‹ä»¶</option>
						<option value="1">æ¯å¹´é‡å¤</option>
						<option value="2">æ¯æœˆé‡å¤</option>
						<option value="3">æ¯å‘¨é‡å¤</option>
						<option value="4">æ¯æ—¥é‡å¤</option>
					</select>
				</div>
				<div class="form-group">
					<label for="countdown-date">ç›®æ ‡æ—¥æœŸ</label>
					<input type="date" id="countdown-date">
				</div>
				<div class="form-group">
					<label for="countdown-time">ç›®æ ‡æ—¶é—´</label>
					<input type="time" id="countdown-time">
				</div>
				<div class="form-group">
					<label for="countdown-priority">ä¼˜å…ˆçº§ (1-10)</label>
					<input type="range" id="countdown-priority" min="1" max="10" value="5">
					<span id="priority-value">5</span>
				</div>
				<div class="form-group">
					<label>
						<input type="checkbox" id="countdown-show-main"> åœ¨ä¸»ç•Œé¢æ˜¾ç¤º
					</label>
				</div>
				<div class="button-group">
					<button id="save-countdown" class="btn-success">ä¿å­˜</button>
					<button id="cancel-countdown" class="btn-secondary">å–æ¶ˆ</button>
				</div>
			</div>

			<!-- ç³»ç»Ÿè®¾ç½® -->
			<div class="section">
				<h2>ç³»ç»Ÿè®¾ç½®</h2>
				<div class="form-group">
					<label for="brightness">äº®åº¦ç­‰çº§</label>
					<input type="range" id="brightness" min="1" max="10" value="5">
					<span id="brightness-value">5</span>
				</div>
				<div class="form-group">
					<label for="refresh-interval">åˆ·æ–°é—´éš” (ç§’)</label>
					<select id="refresh-interval">
						<option value="30">30ç§’</option>
						<option value="60" selected>1åˆ†é’Ÿ</option>
						<option value="300">5åˆ†é’Ÿ</option>
						<option value="600">10åˆ†é’Ÿ</option>
					</select>
				</div>
				<div class="form-group">
					<label>
						<input type="checkbox" id="auto-brightness"> è‡ªåŠ¨äº®åº¦
					</label>
				</div>
				<button id="apply-settings" class="btn-primary">åº”ç”¨è®¾ç½®</button>
			</div>
		</div>
	</div>

	<script src="log.js"></script>

	<script>
		// å…¨å±€å˜é‡
		var connected = false;
		var device = null;
		var longValue = null;
		var ctrlPoint = null;
		var currentCountdownIndex = -1;
		var countdownEvents = [];
		var selectedImage = null;

		// æ˜¾ç¤ºé…ç½®
		var displayConfig = {
			currentMode: 0,
			timeStyle: 0,
			calendarStyle: 0,
			showSeconds: true,
			showDate: true,
			showLunar: true,
			showFestival: true,
			showWeather: false,
			showCountdown: true,
			autoBrightness: true,
			brightnessLevel: 5,
			refreshInterval: 60,
			imageIndex: 0
		};

		// åˆå§‹åŒ–é¡µé¢
		document.addEventListener('DOMContentLoaded', function() {
			initializeUI();
			loadCountdownEvents();
		});

		function initializeUI() {
			// æ ‡ç­¾é¡µåˆ‡æ¢
			document.querySelectorAll('.tab').forEach(tab => {
				tab.addEventListener('click', function() {
					const tabId = this.getAttribute('data-tab');
					switchTab(tabId);
				});
			});

			// æ ·å¼å¡ç‰‡é€‰æ‹©
			document.querySelectorAll('.card').forEach(card => {
				card.addEventListener('click', function() {
					const parent = this.parentElement;
					parent.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
					this.classList.add('selected');
				});
			});

			// å›¾ç‰‡ä¸Šä¼ 
			const imageUpload = document.getElementById('image-upload');
			const imageFile = document.getElementById('image-file');
			
			imageUpload.addEventListener('click', () => imageFile.click());
			imageFile.addEventListener('change', handleImageSelect);
			
			// æ‹–æ‹½ä¸Šä¼ 
			imageUpload.addEventListener('dragover', handleDragOver);
			imageUpload.addEventListener('drop', handleImageDrop);

			// å€’æ•°æ—¥ç®¡ç†
			document.getElementById('add-countdown').addEventListener('click', showCountdownForm);
			document.getElementById('save-countdown').addEventListener('click', saveCountdown);
			document.getElementById('cancel-countdown').addEventListener('click', hideCountdownForm);

			// æ»‘å—å€¼æ˜¾ç¤º
			document.getElementById('countdown-priority').addEventListener('input', function() {
				document.getElementById('priority-value').textContent = this.value;
			});
			document.getElementById('brightness').addEventListener('input', function() {
				document.getElementById('brightness-value').textContent = this.value;
			});

			// æŒ‰é’®äº‹ä»¶
			document.getElementById('connect-button').addEventListener('click', onClick);
			document.getElementById('setime-button').addEventListener('click', syncTime);
			document.getElementById('upload-image').addEventListener('click', uploadImage);
			document.getElementById('apply-settings').addEventListener('click', applySettings);
		}

		function switchTab(tabId) {
			// åˆ‡æ¢æ ‡ç­¾é¡µ
			document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
			document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
			
			document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
			document.getElementById(tabId).classList.add('active');
		}

		function formatTime(year, month, mday, hour, min, sec) {
			month += 1;
			if(month<10) month = '0'+month;
			if(mday<10)  mday  = '0'+mday;
			if(hour<10)  hour  = '0'+hour;
			if(min<10)   min   = '0'+min;
			if(sec<10)   sec   = '0'+sec;
			return year+"-"+month+"-"+mday+" "+hour+":"+min+":"+sec+" ";
		}

		function onClick() {
			if(connected) {
				disconnect();
			}else{
				connectToDevice();
			}
		}

		async function connectToDevice() {
			try {
				console.log('è¯·æ±‚è®¾å¤‡...');
				device = await navigator.bluetooth.requestDevice({
					filters: [{ namePrefix: "DLG-CLOCK"}]
					, optionalServices: [ 0xff00 ]
				});
				console.log('device: ', device.name);
				document.getElementById('device_name').textContent = "è®¾å¤‡å: "+device.name;
				device.ongattserverdisconnected = onDisconnect;

				var server = await device.gatt.connect();
				console.log('è®¾å¤‡å·²è¿æ¥!');

				var service = await server.getPrimaryService( 0xff00 );
				console.log('è·å¾—service: ', service.uuid);

				ctrlPoint = await service.getCharacteristic( 0xff03 );
				var adc1Value = await service.getCharacteristic( 0xff02 );
				longValue = await service.getCharacteristic( 0xff01 );

				cur_voltage = await adc1Value.readValue();
				console.log('cur_voltage:', cur_voltage);
				document.getElementById('current_voltage').textContent = "å½“å‰ç”µå‹: "+cur_voltage.getUint16(0, true) + "mV";

				var year, month, mday, wday, hour, minute, second;
				cur_time = await longValue.readValue();
				year   = cur_time.getUint16(0, true);
				month  = cur_time.getUint8(2);
				mday   = cur_time.getUint8(3);
				wday   = cur_time.getUint8(4);
				hour   = cur_time.getUint8(5);
				minute = cur_time.getUint8(6);
				second = cur_time.getUint8(7);

				document.getElementById('current_time').textContent = "è®¾å¤‡æ—¶é—´: "+formatTime(year, month, mday, hour, minute, second);

				connected = true;
				document.getElementById('connect-button').textContent = 'æ–­å¼€è¿æ¥';
				document.getElementById('connect-button').className = 'btn-danger';
				document.getElementById('setime-button').disabled = false;
				document.getElementById('upfirm-button').disabled = false;

				// åŠ è½½è®¾å¤‡é…ç½®
				await loadDeviceConfig();

			} catch (error) {
				console.error('è¿æ¥å¤±è´¥:', error);
				alert('è¿æ¥å¤±è´¥: ' + error.message);
			}
		}

		function onDisconnect() {
			console.log('è®¾å¤‡å·²æ–­å¼€è¿æ¥');
			connected = false;
			device = null;
			longValue = null;
			ctrlPoint = null;
			
			document.getElementById('connect-button').textContent = 'è¿æ¥è®¾å¤‡';
			document.getElementById('connect-button').className = 'btn-primary';
			document.getElementById('setime-button').disabled = true;
			document.getElementById('upfirm-button').disabled = true;
			
			document.getElementById('device_name').textContent = '';
			document.getElementById('current_voltage').textContent = '';
			document.getElementById('current_time').textContent = '';
		}

		function disconnect() {
			if (device && device.gatt.connected) {
				device.gatt.disconnect();
			}
		}

		async function syncTime() {
			if (!connected || !longValue) {
				alert('è®¾å¤‡æœªè¿æ¥');
				return;
			}

			try {
				var now = new Date();
				var buffer = new ArrayBuffer(8);
				var view = new DataView(buffer);
				
				view.setUint16(0, now.getFullYear(), true);
				view.setUint8(2, now.getMonth());
				view.setUint8(3, now.getDate());
				view.setUint8(4, now.getDay());
				view.setUint8(5, now.getHours());
				view.setUint8(6, now.getMinutes());
				view.setUint8(7, now.getSeconds());

				await longValue.writeValue(buffer);
				console.log('æ—¶é—´åŒæ­¥æˆåŠŸ');
				alert('æ—¶é—´åŒæ­¥æˆåŠŸ');
				
				// æ›´æ–°æ˜¾ç¤ºçš„ç³»ç»Ÿæ—¶é—´
				document.getElementById('system_time').textContent = "ç³»ç»Ÿæ—¶é—´: " + now.toLocaleString();
				
			} catch (error) {
				console.error('æ—¶é—´åŒæ­¥å¤±è´¥:', error);
				alert('æ—¶é—´åŒæ­¥å¤±è´¥: ' + error.message);
			}
		}

		// å›¾ç‰‡å¤„ç†å‡½æ•°
		function handleImageSelect(event) {
			const file = event.target.files[0];
			if (file) {
				processImageFile(file);
			}
		}

		function handleDragOver(event) {
			event.preventDefault();
			event.currentTarget.classList.add('dragover');
		}

		function handleImageDrop(event) {
			event.preventDefault();
			event.currentTarget.classList.remove('dragover');
			
			const files = event.dataTransfer.files;
			if (files.length > 0) {
				processImageFile(files[0]);
			}
		}

		function processImageFile(file) {
			if (file.size > 32 * 1024) {
				alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº32KBçš„å›¾ç‰‡');
				return;
			}

			const reader = new FileReader();
			reader.onload = function(e) {
				selectedImage = e.target.result;
				
				// æ˜¾ç¤ºé¢„è§ˆ
				const preview = document.getElementById('image-preview');
				preview.innerHTML = `<img src="${selectedImage}" class="image-preview" alt="å›¾ç‰‡é¢„è§ˆ">`;
				
				document.getElementById('upload-image').disabled = false;
			};
			reader.readAsDataURL(file);
		}

		async function uploadImage() {
			if (!selectedImage || !connected) {
				alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡å¹¶è¿æ¥è®¾å¤‡');
				return;
			}

			try {
				// è¿™é‡Œåº”è¯¥å®ç°å›¾ç‰‡ä¸Šä¼ åˆ°è®¾å¤‡çš„é€»è¾‘
				// æš‚æ—¶æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
				alert('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ');
				console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ');
				
			} catch (error) {
				console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
				alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message);
			}
		}

		// å€’æ•°æ—¥ç®¡ç†å‡½æ•°
		function loadCountdownEvents() {
			// ä»æœ¬åœ°å­˜å‚¨åŠ è½½å€’æ•°æ—¥äº‹ä»¶
			const saved = localStorage.getItem('countdownEvents');
			if (saved) {
				countdownEvents = JSON.parse(saved);
			} else {
				// æ·»åŠ ä¸€äº›ç¤ºä¾‹äº‹ä»¶
				countdownEvents = [
					{
						name: 'æ˜¥èŠ‚',
						desc: 'ä¸­å›½ä¼ ç»Ÿæ–°å¹´',
						type: 1, // æ¯å¹´é‡å¤
						targetDate: '2025-01-29',
						targetTime: '00:00',
						priority: 10,
						showOnMain: true
					},
					{
						name: 'ä¸­ç§‹èŠ‚',
						desc: 'å›¢åœ†ä½³èŠ‚',
						type: 1, // æ¯å¹´é‡å¤
						targetDate: '2025-10-06',
						targetTime: '00:00',
						priority: 8,
						showOnMain: true
					}
				];
			}
			updateCountdownList();
		}

		function saveCountdownEvents() {
			localStorage.setItem('countdownEvents', JSON.stringify(countdownEvents));
		}

		function updateCountdownList() {
			const list = document.getElementById('countdown-list');
			list.innerHTML = '';

			countdownEvents.forEach((event, index) => {
				const item = document.createElement('div');
				item.className = 'countdown-item';
				
				const typeNames = ['ä¸€æ¬¡æ€§', 'æ¯å¹´', 'æ¯æœˆ', 'æ¯å‘¨', 'æ¯æ—¥'];
				
				item.innerHTML = `
					<div class="countdown-info">
						<div class="countdown-name">${event.name}</div>
						<div class="countdown-date">${event.targetDate} ${event.targetTime} (${typeNames[event.type]})</div>
						<div class="countdown-date">${event.desc}</div>
					</div>
					<div class="countdown-actions">
						<button class="btn-secondary" onclick="editCountdown(${index})">ç¼–è¾‘</button>
						<button class="btn-danger" onclick="deleteCountdown(${index})">åˆ é™¤</button>
					</div>
				`;
				
				list.appendChild(item);
			});
		}

		function showCountdownForm(index = -1) {
			currentCountdownIndex = index;
			const form = document.getElementById('countdown-form');
			
			if (index >= 0) {
				// ç¼–è¾‘æ¨¡å¼
				const event = countdownEvents[index];
				document.getElementById('countdown-name').value = event.name;
				document.getElementById('countdown-desc').value = event.desc;
				document.getElementById('countdown-type').value = event.type;
				document.getElementById('countdown-date').value = event.targetDate;
				document.getElementById('countdown-time').value = event.targetTime;
				document.getElementById('countdown-priority').value = event.priority;
				document.getElementById('priority-value').textContent = event.priority;
				document.getElementById('countdown-show-main').checked = event.showOnMain;
			} else {
				// æ–°å»ºæ¨¡å¼
				document.getElementById('countdown-name').value = '';
				document.getElementById('countdown-desc').value = '';
				document.getElementById('countdown-type').value = '0';
				document.getElementById('countdown-date').value = '';
				document.getElementById('countdown-time').value = '00:00';
				document.getElementById('countdown-priority').value = '5';
				document.getElementById('priority-value').textContent = '5';
				document.getElementById('countdown-show-main').checked = true;
			}
			
			form.style.display = 'block';
		}

		function hideCountdownForm() {
			document.getElementById('countdown-form').style.display = 'none';
			currentCountdownIndex = -1;
		}

		function saveCountdown() {
			const name = document.getElementById('countdown-name').value.trim();
			const desc = document.getElementById('countdown-desc').value.trim();
			const type = parseInt(document.getElementById('countdown-type').value);
			const targetDate = document.getElementById('countdown-date').value;
			const targetTime = document.getElementById('countdown-time').value;
			const priority = parseInt(document.getElementById('countdown-priority').value);
			const showOnMain = document.getElementById('countdown-show-main').checked;

			if (!name || !targetDate) {
				alert('è¯·å¡«å†™äº‹ä»¶åç§°å’Œç›®æ ‡æ—¥æœŸ');
				return;
			}

			const event = {
				name,
				desc,
				type,
				targetDate,
				targetTime,
				priority,
				showOnMain
			};

			if (currentCountdownIndex >= 0) {
				// æ›´æ–°ç°æœ‰äº‹ä»¶
				countdownEvents[currentCountdownIndex] = event;
			} else {
				// æ·»åŠ æ–°äº‹ä»¶
				countdownEvents.push(event);
			}

			saveCountdownEvents();
			updateCountdownList();
			hideCountdownForm();
			
			// å¦‚æœè®¾å¤‡å·²è¿æ¥ï¼ŒåŒæ­¥åˆ°è®¾å¤‡
			if (connected) {
				syncCountdownToDevice();
			}
		}

		function editCountdown(index) {
			showCountdownForm(index);
		}

		function deleteCountdown(index) {
			if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå€’æ•°æ—¥äº‹ä»¶å—ï¼Ÿ')) {
				countdownEvents.splice(index, 1);
				saveCountdownEvents();
				updateCountdownList();
				
				// å¦‚æœè®¾å¤‡å·²è¿æ¥ï¼ŒåŒæ­¥åˆ°è®¾å¤‡
				if (connected) {
					syncCountdownToDevice();
				}
			}
		}

		async function syncCountdownToDevice() {
			if (!connected || !ctrlPoint) {
				return;
			}

			try {
				// è¿™é‡Œåº”è¯¥å®ç°å€’æ•°æ—¥æ•°æ®åŒæ­¥åˆ°è®¾å¤‡çš„é€»è¾‘
				console.log('åŒæ­¥å€’æ•°æ—¥æ•°æ®åˆ°è®¾å¤‡');
				
			} catch (error) {
				console.error('åŒæ­¥å€’æ•°æ—¥æ•°æ®å¤±è´¥:', error);
			}
		}

		async function applySettings() {
			if (!connected) {
				alert('è¯·å…ˆè¿æ¥è®¾å¤‡');
				return;
			}

			try {
				// æ”¶é›†è®¾ç½®
				displayConfig.showSeconds = document.getElementById('show-seconds').checked;
				displayConfig.showDate = document.getElementById('show-date').checked;
				displayConfig.showLunar = document.getElementById('show-lunar').checked;
				displayConfig.showFestival = document.getElementById('show-festival').checked;
				displayConfig.brightnessLevel = parseInt(document.getElementById('brightness').value);
				displayConfig.refreshInterval = parseInt(document.getElementById('refresh-interval').value);
				displayConfig.autoBrightness = document.getElementById('auto-brightness').checked;

				// è·å–é€‰ä¸­çš„æ ·å¼
				const selectedTimeStyle = document.querySelector('#time-mode .card.selected');
				if (selectedTimeStyle) {
					const styles = ['digital', 'analog', 'minimal', 'retro', 'neon'];
					displayConfig.timeStyle = styles.indexOf(selectedTimeStyle.getAttribute('data-style'));
				}

				const selectedCalendarStyle = document.querySelector('#calendar-mode .card.selected');
				if (selectedCalendarStyle) {
					const styles = ['grid', 'list', 'minimal', 'chinese', 'modern'];
					displayConfig.calendarStyle = styles.indexOf(selectedCalendarStyle.getAttribute('data-style'));
				}

				// è¿™é‡Œåº”è¯¥å®ç°é…ç½®åŒæ­¥åˆ°è®¾å¤‡çš„é€»è¾‘
				console.log('åº”ç”¨è®¾ç½®:', displayConfig);
				alert('è®¾ç½®å·²åº”ç”¨');
				
			} catch (error) {
				console.error('åº”ç”¨è®¾ç½®å¤±è´¥:', error);
				alert('åº”ç”¨è®¾ç½®å¤±è´¥: ' + error.message);
			}
		}

		async function loadDeviceConfig() {
			if (!connected) {
				return;
			}

			try {
				// è¿™é‡Œåº”è¯¥å®ç°ä»è®¾å¤‡åŠ è½½é…ç½®çš„é€»è¾‘
				console.log('ä»è®¾å¤‡åŠ è½½é…ç½®');
				
				// æ›´æ–°UI
				document.getElementById('show-seconds').checked = displayConfig.showSeconds;
				document.getElementById('show-date').checked = displayConfig.showDate;
				document.getElementById('show-lunar').checked = displayConfig.showLunar;
				document.getElementById('show-festival').checked = displayConfig.showFestival;
				document.getElementById('brightness').value = displayConfig.brightnessLevel;
				document.getElementById('brightness-value').textContent = displayConfig.brightnessLevel;
				document.getElementById('refresh-interval').value = displayConfig.refreshInterval;
				document.getElementById('auto-brightness').checked = displayConfig.autoBrightness;
				
			} catch (error) {
				console.error('åŠ è½½è®¾å¤‡é…ç½®å¤±è´¥:', error);
			}
		}

		// å®šæ—¶æ›´æ–°ç³»ç»Ÿæ—¶é—´æ˜¾ç¤º
		setInterval(function() {
			const now = new Date();
			document.getElementById('system_time').textContent = "ç³»ç»Ÿæ—¶é—´: " + now.toLocaleString();
		}, 1000);

	</script>
</body>
</html>

				var service = await server.getPrimaryService( 0xff00 );
				console.log('è·å¾—service: ', service.uuid);

				var ctrlPoint = await service.getCharacteristic( 0xff03 );
				var adc1Value = await service.getCharacteristic( 0xff02 );
				longValue = await service.getCharacteristic( 0xff01 );

				cur_voltage = await adc1Value.readValue();
				console.log('cur_voltage:', cur_voltage);
				document.getElementById('current_voltage').textContent = "å½“å‰ç”µå‹: "+cur_voltage.getUint16(0, true);

				var year, month, mday, wday, hour, minute, second;
				cur_time = await longValue.readValue();
				year   = cur_time.getUint16(0, true);
				month  = cur_time.getUint8(2);
				mday   = cur_time.getUint8(3);
				hour   = cur_time.getUint8(4);
				minute = cur_time.getUint8(5);
				second = cur_time.getUint8(6);
				document.getElementById('current_time').textContent = "å½“å‰æ—¶é—´: "+formatTime(year, month, mday, hour, minute, second);

				var buf = new Uint8Array(10);
				var today = new Date();
				year = today.getFullYear();
				month = today.getMonth();
				mday = today.getDate();
				wday = today.getDay();
				hour = today.getHours();
				minute = today.getMinutes();
				second = today.getSeconds();
				document.getElementById('system_time').textContent = "ç³»ç»Ÿæ—¶é—´: "+formatTime(year, month, mday, hour, minute, second);

				connected = true;
				document.getElementById('setime-button').disabled = false;
				document.getElementById('connect-button').textContent = "æ–­å¼€";
			} catch (error) {
				console.log('è¿æ¥å¤±è´¥:', error);
				disconnect();
			}
		}

		async function onSetTime() {
			document.getElementById('setime-button').disabled = true;

			var today = new Date();
			year = today.getFullYear();
			month = today.getMonth();
			mday = today.getDate();
			wday = today.getDay();
			hour = today.getHours();
			minute = today.getMinutes();
			second = today.getSeconds();

			locale_str = today.toLocaleDateString('zh-CN-u-ca-chinese',{month:'numeric',day:'numeric'});
			l_month = 0;
			if(locale_str.charAt(0)=='é—°'){
				l_month = 128;
				locale_str = locale_str.substr(1,);
			}
			lstr_split = locale_str.split('-');
			l_month += parseInt(lstr_split[0]);
			l_mday   = parseInt(lstr_split[1]);
			locale_year = today.toLocaleDateString('zh-CN-u-ca-chinese',{year:'numeric'});
			l_year = parseInt(locale_year.substr(0,4));
			console.log('å¹´:', l_year, 'æœˆ:', l_month, 'æ—¥:', l_mday);

			var buf = new Uint8Array(12);
			buf[0] = 0x91;
			buf[1] = year%256;
			buf[2] = year/256;
			buf[3] = month;
			buf[4] = mday;
			buf[5] = hour;
			buf[6] = minute;
			buf[7] = second;
			buf[8] = wday;
			buf[9] = l_year-2020;
			buf[10]= l_month-1;
			buf[11]= l_mday;
			await longValue.writeValue(buf);

			document.getElementById('system_time').textContent = "ç³»ç»Ÿæ—¶é—´: "+formatTime(year, month, mday, hour, minute, second);
			console.log('åŒæ­¥æ—¶é—´æˆåŠŸ!');
			document.getElementById('setime-button').disabled = false;
		}

		function disconnect() {
			document.getElementById('setime-button').disabled = true;
			if(!device)
				return;
			if(device.gatt.connected){
				device.gatt.disconnect();
			}
			onDisconnect();
		}

		function onDisconnect() {
			device = null;
			console.log('è®¾å¤‡å·²æ–­å¼€è¿æ¥');
			connected = false;
			document.getElementById('setime-button').disabled = true;
			document.getElementById('connect-button').textContent = "è¿æ¥";
		}

		document.getElementById('connect-button').addEventListener('click', onClick);
		document.getElementById('setime-button').addEventListener('click', onSetTime);
	</script>
</body>
</html>


