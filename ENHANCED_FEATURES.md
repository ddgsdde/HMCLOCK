# 增强版电子墨水屏时钟固件功能说明

## 新增功能概述

基于二次开发指南，本固件增加了以下功能：

### 1. 蓝牙指令扩展

#### 基础控制指令
- `0xAA` - 重启设备
- `0xDD + 时间数据` - 新格式时间同步
- `0xE0 0x01` - 修改屏幕/清空屏幕
- `0xE2` - 屏幕强制刷新
- `0xE3` - 全屏反色显示切换

#### 显示模式切换
- `0xE1 0x00` - 切换为图片模式
- `0xE1 0x01` - 切换为日历模式  
- `0xE1 0x02` - 切换为时钟模式

#### 时区设置
- `0xE4` - 当前时区+1
- `0xEF + 时区值` - 设置指定时区 (范围: -12 到 +12)

#### 自定义内容
- `0xF2 + 文本内容` - 设置自定义文本显示
- `$` 或 `@` 开头 - 重置显示内容
- `###` - 保存参数到Flash

### 2. 显示模式

#### 时钟模式 (默认)
- 显示当前时间（支持时区偏移）
- 显示公历日期和星期
- 显示农历日期
- 显示节气和节假日
- 显示电池电量和蓝牙状态
- 支持反色显示

#### 日历模式
- 大字显示年月
- 显示当前日期和星期
- 显示农历信息
- 简洁的日历布局

#### 图片模式
- 预留图片显示功能
- 支持简单位图显示

#### 自定义文本模式
- 支持自定义文本内容
- 支持变量替换功能

### 3. 变量替换系统

在自定义文本中可以使用以下变量：

- `{Y}` - 汉字年份 (如: 2024年)
- `{y}` - 数字年份 (如: 2024)
- `{M}` - 汉字月份 (如: 5月)
- `{m}` - 数字月份 (如: 05)
- `{D}` - 汉字日期 (如: 29日)
- `{d}` - 数字日期 (如: 29)
- `{W}` - 汉字星期 (如: 星期三)
- `{w}` - 数字星期 (如: 3)

#### 使用示例
```
今天是{Y}{M}{D} {W}
现在时间: {y}-{m}-{d}
```

### 4. 绘图函数扩展

新增了以下绘图函数，支持二次开发：

- `draw_point(x, y, color)` - 画点
- `draw_line(x1, y1, x2, y2, color)` - 画线
- `draw_circle(cx, cy, radius, color)` - 画圆
- `draw_filled_circle(cx, cy, radius, color)` - 填充圆
- `draw_rectangle(x1, y1, x2, y2, color, filled)` - 画矩形
- `draw_image(x, y, width, height, data, color)` - 显示图片

### 5. 时区支持

- 支持UTC-12到UTC+12的时区设置
- 默认为UTC+8（北京时间）
- 时区信息会显示在屏幕上
- 支持动态时区调整

### 6. 反色显示

- 支持全屏反色显示
- 黑白颜色完全反转
- 适用于所有显示模式
- 通过蓝牙指令控制

## 增强版Web控制界面

新增了 `enhanced_weble.html` 文件，提供了完整的Web控制界面：

### 功能特性
- 设备连接和状态监控
- 时间同步和时区设置
- 显示模式切换
- 屏幕控制（刷新、反色、清空）
- 自定义文本输入和发送
- 参数保存功能

### 使用方法
1. 用支持Web Bluetooth的浏览器打开 `enhanced_weble.html`
2. 点击"连接设备"按钮
3. 选择对应的电子墨水屏设备
4. 使用各种控制按钮进行操作

## 编译说明

### 环境要求
- Keil 5 开发环境
- DA14585 SDK 6.0.22.1401
- 支持的电子墨水屏硬件

### 编译步骤
1. 打开 `Keil_5/ble_app_peripheral.uvprojx` 项目文件
2. 确保SDK路径配置正确
3. 编译生成 `.bin` 文件
4. 使用对应的烧录工具烧录到设备

### 主要修改文件
- `src/user_custs1_impl.c` - 蓝牙指令处理和新功能实现
- `src/epd/epd_gui.c` - 绘图函数扩展
- `src/epd/epd.h` - 函数声明更新
- `weble/enhanced_weble.html` - 增强版Web控制界面

## 兼容性说明

- 向后兼容原有的时间同步功能
- 保持原有的显示效果和性能
- 新功能通过蓝牙指令激活，不影响默认行为
- 支持所有原有的电子墨水屏型号

## 使用建议

1. **时区设置**: 首次使用时建议设置正确的时区
2. **参数保存**: 配置完成后使用 `###` 指令保存参数
3. **自定义文本**: 建议使用变量替换功能实现动态内容
4. **反色显示**: 在强光环境下可以尝试反色显示提高可读性
5. **模式切换**: 根据使用场景选择合适的显示模式

## 故障排除

1. **连接失败**: 确保设备处于广播状态，检查蓝牙权限
2. **指令无响应**: 检查设备连接状态，重新连接设备
3. **显示异常**: 使用强制刷新指令或重启设备
4. **时区错误**: 重新设置时区并保存参数

## 技术支持

如有问题，请检查：
1. 设备固件版本是否为增强版
2. Web浏览器是否支持Web Bluetooth API
3. 设备电量是否充足
4. 蓝牙连接是否稳定